#!/usr/bin/env bash

set -e
set -x

function system()
{
    if [[ "$OSTYPE" == "linux-gnu" ]]; then
        echo "linux";
    else
        if [[ "$OSTYPE" == "msys" ]]; then
            echo "msys";
        else
            echo "unknown";
        fi;
    fi
}

function winify() {
	if [[ "$(system)" = "msys"  ]]; then
		echo $1 | sed 's|^/\([a-z,A-Z]\)/|\1:/|';
	else
		echo $1;
	fi
}

function normalize() {
	echo $(winify $(realpath $1))
}
  
OP="$HOME/.op"
echo $OP

rm -Rvf "$OP"
rm -vf $HOME/.emacs.d/projectile*

mkdir -p "$OP"

# not good:
# for stddir in $(find $(dirname $(which gcc))/.. -name "include" -type d)
# do
# 	echo ctags.exe -a -f $OP/TAGS -Re $(normalize $stddir)
# done

# bug on linux if a directory has no subdir containing the source files.
# => setting projectile-bookmarks.eld fixes it.
echo -n "(" > $HOME/.emacs.d/projectile-bookmarks.eld
for D in "$@"
do
	N=$(normalize $D)
 	touch $N/.projectile
 	echo -n " \"$N/\"" >> $HOME/.emacs.d/projectile-bookmarks.eld
	echo -n $N " " >> $OP/projectiles
	# append
	if [[ "$(system)" = "msys"  ]]; then
		ctags -a -f $OP/TAGS -Re $N 
	else
		ctags-exuberant -a -f $OP/TAGS -Re $N 
	fi
	# TODO instruct ag to ignore these bak files.
	find $N -name "*~"  -o -name "*~*TMP*" -o -name "#*" -delete
	ls -lh $OP/TAGS
done
echo -n ")" >> $HOME/.emacs.d/projectile-bookmarks.eld

pushd $1
export OSTYPE
emacs &
popd

